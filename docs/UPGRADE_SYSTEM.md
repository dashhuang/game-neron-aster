# 升级系统文档

本文档详细说明 Roguelite 升级系统的设计和使用。

---

## 📖 系统概述

### 核心机制

玩家通过击杀敌人获得经验，升级时可以从 3 张随机升级卡中选择 1 张，永久强化角色属性。

### 设计目标

- 🎲 **随机性** - 每次升级选项不同
- 🔄 **可叠加** - 同一升级可多次选择
- ⚖️ **平衡性** - 稀有度决定强度
- 🎨 **视觉化** - 清晰的UI反馈

---

## 🎮 玩家体验

### 升级流程

```
1. 击杀敌人获得经验
   ↓
2. 经验满后升级
   ↓
3. 游戏暂停，显示升级面板
   ↓
4. 显示 3 张随机升级卡
   ↓
5. 玩家点击选择1张
   ↓
6. 属性立即生效
   ↓
7. 继续游戏
```

---

## 📊 可升级属性列表

### 攻击系（5种）

| 升级名称 | 效果 | 稀有度 | 说明 |
|---------|------|--------|------|
| 火力提升 | 伤害 +10% | 普通 | 提升子弹伤害 |
| 疾速射击 | 射速 +15% | 普通 | 提升射击频率 |
| 极速弹道 | 弹速 +20% | 普通 | 子弹飞得更快 |
| 穿透子弹 | 穿透 +1 | 稀有 | 可穿透敌人 |
| 弹跳子弹 | 弹跳 +1 | 稀有 | 碰壁弹跳 |

### 生存系（2种）

| 升级名称 | 效果 | 稀有度 | 说明 |
|---------|------|--------|------|
| 生命强化 | 最大HP +20 | 普通 | 提升生存能力 |
| 移速提升 | 速度 +10% | 普通 | 移动更快 |

### 效率系（2种）

| 升级名称 | 效果 | 稀有度 | 说明 |
|---------|------|--------|------|
| 磁力增强 | 磁吸 +30% | 普通 | 拾取范围扩大 |
| 经验加成 | 经验 +20% | 稀有 | 升级更快 |

### 视觉系（1种）

| 升级名称 | 效果 | 稀有度 | 说明 |
|---------|------|--------|------|
| 巨大化 | 子弹大小 +30% | 普通 | 子弹更大 |

---

## ⚙️ 技术实现

### 组件系统

#### StatModifier 组件
```typescript
interface StatModifier {
  modifiers: {
    stat: string;          // 属性名
    operation: 'add' | 'multiply';  // 操作类型
    value: number;         // 数值
  }[];
}
```

#### 属性计算公式
```typescript
最终值 = (基础值 + 所有加法修改器) × 所有乘法修改器的乘积
```

### 配置格式

**文件**: `public/data/upgrades/upgrades.json`

```json
{
  "id": "damage_boost_1",
  "name": "火力提升",
  "description": "伤害 +10%",
  "rarity": "common",
  "effects": [
    {
      "stat": "damage",
      "operation": "multiply",
      "value": 1.1
    }
  ]
}
```

---

## 🎨 UI 设计

### 升级面板

```
┌─────────────────────────────────────┐
│          选择升级                    │
├─────────────────────────────────────┤
│  ┌─────┐  ┌─────┐  ┌─────┐         │
│  │普通 │  │稀有 │  │普通 │         │
│  │     │  │     │  │     │         │
│  │火力 │  │穿透 │  │移速 │         │
│  │提升 │  │子弹 │  │提升 │         │
│  │     │  │     │  │     │         │
│  │伤害 │  │穿透 │  │速度 │         │
│  │+10% │  │ +1  │  │+10% │         │
│  └─────┘  └─────┘  └─────┘         │
└─────────────────────────────────────┘
```

### 稀有度颜色

| 稀有度 | 边框颜色 | 概率 |
|--------|----------|------|
| 普通 | 灰色 `#888888` | 70% |
| 稀有 | 紫色 `#aa44ff` | 25% |
| 史诗 | 金色 `#ffaa00` | 5% |

---

## 📝 如何添加新升级卡

### 步骤 1：编辑配置文件

**文件**: `public/data/upgrades/upgrades.json`

```json
{
  "id": "crit_chance_1",
  "name": "致命一击",
  "description": "暴击率 +15%",
  "rarity": "rare",
  "effects": [
    {
      "stat": "critChance",
      "operation": "add",
      "value": 0.15
    }
  ],
  "tags": ["attack", "crit"]
}
```

### 步骤 2：刷新游戏

配置会自动加载，新升级卡会出现在随机池中。

### 步骤 3：实现属性效果（如果是新属性）

如果是全新的属性（如 critChance），需要：
1. 在 `StatModifierSystem` 中添加应用逻辑
2. 在相关系统中使用修改后的值

---

## 🔄 属性修改器工作原理

### 示例：伤害计算

```typescript
// 基础伤害
baseDamage = 12

// 玩家选择了：
// 1. 火力提升（伤害 ×1.1）
// 2. 火力提升（伤害 ×1.1）又选了一次
// 3. 伤害 +5（假设）

// 计算过程
addValue = 5
multiplyValue = 1.1 × 1.1 = 1.21

最终伤害 = (12 + 5) × 1.21 = 20.57
```

### 叠加规则

- **同类型加法**：直接相加
- **同类型乘法**：相乘（1.1 × 1.1 = 1.21）
- **不同类型**：分别计算后合并

---

## 🎯 平衡建议

### 数值设计原则

1. **普通升级**：10-15% 提升
2. **稀有升级**：20-30% 提升或特殊效果
3. **史诗升级**：50%+ 提升或变革性效果

### 叠加上限

建议设置软上限，避免数值爆炸：
- 同一属性选择 3-5 次后边际收益递减
- 或者出现次数限制（maxStacks）

---

## 🚀 扩展方向

### 未来可添加

#### 复杂效果
- **条件触发** - 低血量时伤害翻倍
- **组合效果** - 同时拥有A和B时触发C
- **变革性升级** - 改变游戏玩法（如激光束）

#### 升级进化
- 同一升级选择3次后进化为更强版本
- 例如：火力提升 → 火力爆发 → 毁灭之力

#### 稀有度提升
- 添加传说级（Legendary）
- 添加神话级（Mythic）

---

## 📚 配置字段参考

### UpgradeConfig

| 字段 | 类型 | 说明 |
|------|------|------|
| `id` | string | 唯一标识符 |
| `name` | string | 显示名称 |
| `description` | string | 效果描述 |
| `rarity` | string | 稀有度：common/rare/epic |
| `effects` | StatEffect[] | 效果列表 |
| `tags` | string[] | 标签（可选） |

### StatEffect

| 字段 | 类型 | 说明 |
|------|------|------|
| `stat` | string | 属性名 |
| `operation` | string | add（加法）或 multiply（乘法） |
| `value` | number | 数值 |

---

## 🐛 调试

### 查看玩家升级

在浏览器控制台：
```javascript
// 查看玩家的修改器
const player = world.entities.find(e => e.getComponent('Tag')?.value === 'player');
const statMod = player.getComponent('StatModifier');
console.log(statMod.modifiers);
```

### 强制触发升级

```javascript
world.eventBus.emit('levelup', { level: 2 });
### 验证穿透是否生效

1. 在升级面板选择「穿透子弹」。
2. 控制台应看到子弹创建日志：`{ pierce: 1, ... }`。
3. 命中一排敌人时，控制台会输出：`💥 子弹穿透！剩余穿透次数: 0`。
4. 视觉表现：子弹穿过第1个敌人继续命中第2个，再销毁。

> 实现要点：`CollisionSystem` 只在需要销毁时才中止循环；`Projectile.hitSet` 记录已命中的敌人避免重复结算。
```

---

**版本**: 1.0  
**更新日期**: 2025-11-06

